<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:xhtml="http://www.w3.org/1999/xhtml">
{%- for file in pages %}
    {%- if file.page.is_link %}
        {%- continue %}
    {%- endif %}

    {%- if file.page.canonical_url %}
        {%- set default_href = file.page.canonical_url | e %}
    {%- elif file.page.abs_url %}
        {%- set default_href = file.page.abs_url | e %}
    {%- else %}
        {%- set default_href = config.site_url ~ file.url %}
    {%- endif %}

    {%- set default_locale = file.page.locale %}
    {%- set flag = namespace(added_default=false) %}

    {#-
        Warning! Don't align the XML tags based on the Jinja2 statements.
        It will cause whitespace misalignment in the output.
    #}
    <url>
        <loc>{{ default_href }}</loc>
    {%- if file.page.update_date %}
        <lastmod>{{ file.page.update_date }}</lastmod>
    {%- endif %}
        <changefreq>daily</changefreq>
    {%- for i18n_locale, i18n_alt in file.alternates.items() %}
        {%- if not i18n_alt or i18n_locale == default_locale %}
            {%- continue %}
        {%- endif %}

        {%- if i18n_alt.page.canonical_url %}
            {%- set i18n_href = i18n_alt.page.canonical_url | e %}
        {%- elif i18n_alt.page.abs_url %}
            {%- set i18n_href = i18n_alt.page.abs_url | e %}
        {%- else %}
            {%- set i18n_href = config.site_url ~ i18n_alt.url %}
        {%- endif %}

        {#- If the default language is the same as the alternate, then skip the alternate #}
        {%- if default_href == i18n_href %}
            {%- continue %}
        {%- endif %}

        {%- if not flag.added_default %}
        <xhtml:link rel="alternate" hreflang="{{ default_locale }}" href="{{ default_href }}"/>
            {%- set flag.added_default = True %}
        {%- endif %}
        <xhtml:link rel="alternate" hreflang="{{ i18n_locale }}" href="{{ i18n_href }}"/>
    {%- endfor %}
    </url>

    {%- for alternate_locale, alternate in file.alternates.items() %}
        {%- if not alternate or alternate_locale == default_locale %}
            {%- continue %}
        {%- endif %}

        {%- if alternate.page.canonical_url %}
            {%- set alt_href = alternate.page.canonical_url | e %}
        {%- elif alternate.page.abs_url %}
            {%- set alt_href = alternate.page.abs_url | e %}
        {%- else %}
            {%- set alt_href = config.site_url ~ alternate.url %}
        {%- endif %}

        {#- If the default language is the same as the alternate, then skip the alternate #}
        {%- if default_href == alt_href %}
            {%- continue %}
        {%- endif %}

    {#-
        Warning! Don't align the XML tags based on the Jinja2 statements.
        It will cause whitespace misalignment in the output.
    #}
    <url>
        <loc>{{ alt_href }}</loc>
        {%- if alternate.page.update_date %}
        <lastmod>{{ alternate.page.update_date }}</lastmod>
        {%- endif %}
        <changefreq>daily</changefreq>
        <xhtml:link rel="alternate" hreflang="{{ default_locale }}" href="{{ default_href }}"/>
        {%- for i18n_locale, i18n_alt in file.alternates.items() %}
            {%- if not i18n_alt or i18n_locale == default_locale %}
                {%- continue %}
            {%- endif %}

            {%- if i18n_alt.page.canonical_url %}
                {%- set i18n_href = i18n_alt.page.canonical_url | e %}
            {%- elif i18n_alt.page.abs_url %}
                {%- set i18n_href = i18n_alt.page.abs_url | e %}
            {%- else %}
                {%- set i18n_href = config.site_url ~ i18n_alt.url %}
            {%- endif %}

            {#- If the default language is the same as the alternate, then skip the alternate #}
            {%- if default_href == i18n_href %}
                {%- continue %}
            {%- endif %}
        <xhtml:link rel="alternate" hreflang="{{ i18n_locale }}" href="{{ i18n_href }}"/>
        {%- endfor %}
    </url>
    {%- endfor %}
{%- endfor %}
</urlset>
